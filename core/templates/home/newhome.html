{% extends 'core/base.html' %}
{% block content %}
 {% load static %}
<style xmlns="http://www.w3.org/1999/html"></style>
    <meta charset="UTF-8">
    <title>Indian Flag</title>
    <!-- Load PyScript -->

<body style="text-align:center; background:#f0f0f0;">
<audio id="toast-sound" src="{% static '/sound/notify.mp3' %}" preload="auto"></audio>

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
  <div id="cart-toast" class="toast align-items-center text-white border-0" role="alert">
    <div class="d-flex">
      <div class="toast-body">Toast message here</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1100"></div>
<!-- Backdrop Overlay -->
<div id="backdrop" class="backdrop"></div>
      <div id="products-container"  style="display:none; margin-top:20px;" class="products-panel"></div>`
<aside class="sidebar">
  <div class="promo-banner">
    <h3>ߎ Seasonal Sale!</h3>
    <p>Get up to 40% off selected products</p>
    <button id="shop-now-btn">Shop Now</button>
    <canvas id="sparkle-canvas"></canvas>
  </div>
</aside>

<section class="hero"><h2 class="animated-text">Your Style, Our Passion</h2></section>
<!-- Success Message (initially hidden) -->
<div id="booking-response" class="alert alert-success text-center" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1055;">
    Booking successful!</div>
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
             <h5 class="modal-title">Book Appointment</h5>
             <button type="button" class="btn-close flash-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
              <div class="modal-body" id="modalFormContainer">
                <!-- Form gets loaded here -->
              </div>
    </div>
  </div>
</div>


<section class="services">
    <h3>Our Services</h3>
    <div class="service-grid">
        <div class="service">
            <i class="fa-solid fa-person"></i>
            <h4>Haircuts</h4>
            <p>Trendy styles for men & women</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-spa"></i>
            <h4>Spa & Relaxation</h4>
            <p>Facials, massages, and more</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-bahai"></i>
            <h4>Hair Coloring</h4>
            <p>Vibrant, bold or natural tones</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-hand-sparkles"></i>
            <h4>Manicure & Pedicure</h4>
            <p>Clean, care & polish your nails</p>
        </div>
    </div>
</section>

<style>
</style>
{% if user.is_authenticated and not user.is_staff %}
  <!-- Booking form for normal logged-in users -->
  <section id="mini-booking">
    <h3>Quick Booking</h3>
    <form id="booking-form" method="post" action="">
      {% csrf_token %}
      <input type="text" name="service" placeholder="Service" required>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <button type="submit">Book</button>
    </form>
    <div id="booking-response"></div>
  </section>
{% else %}
  {% if not user.is_authenticated %}
    <p><a href="{% url 'login' %}">Log in</a> to book an appointment.</p>
  {% endif %}
{% endif %}
<section id="booking-section">
<section class="cta">
    <h3>Ready for a new look?</h3>
    <p>Book an appointment with our expert stylists today.</p>
    <button id="loadBookingForm" class="cta-btn">Book Now</button>
</section>
</section>
<section class="testimonials">
    <h2>What Our Clients Say</h2>
    <div id="testimonialCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <p>"Amazing service! The best haircut I’ve had in years."</p>
                <strong>- Priya K.</strong>
            </div>
            <div class="carousel-item">
                <p>"Super clean and friendly staff. Highly recommended!"</p>
                <strong>- Rahul S.</strong>
            </div>
            <div class="carousel-item">
                <p>"I love the spa and the relaxation treatments. Highly recommend!"</p>
                <strong>- Neha T.</strong>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#testimonialCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#testimonialCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</section>
<section class="gallery">
    <h2>Salon Gallery</h2>
    <div class="gallery-grid">
        <div class="gallery-item">
            <img src="{% static 'images/gallery1.jpeg' %}" alt="Gallery 1" class="img-fluid">
            <div class="gallery-caption">Hair Styling</div>
        </div>
        <div class="gallery-item">
            <img src="{% static 'images/gallery2.jpeg' %}" alt="Gallery 2" class="img-fluid">
            <div class="gallery-caption">Relaxation Spa</div>
        </div>
        <div class="gallery-item">
            <img src="{% static 'images/gallery3.jpeg' %}" alt="Gallery 3" class="img-fluid">
            <div class="gallery-caption">Hair Coloring</div>
        </div>
    </div>
</section>
<!-- Cart Modal -->
<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">ߛ My Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <table id="cart-table" class="table table-bordered text-center">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Quantity</th>
              <th>Subtotal</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
            <!-- Cart items injected here -->
          </tbody>
        </table>

        <div id="cart-summary" class="mt-3 text-end">
          <p><b>Total Items:</b> <span id="cart-qty">0</span></p>
          <p><b>Total Price:</b> <span id="cartprice">0.00</span></p>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Continue Shopping</button>
        <button type="button" class="btn btn-primary" id="checkout-btn">Checkout</button>
      </div>
    </div>
  </div>
</div>
<div id="checkout-modal" style="display:none;">
    <input type="text" id="full_name" placeholder="Full Name">
    <input type="email" id="email" placeholder="Email">
    <input type="text" id="phone" placeholder="Phone">
    <textarea id="address" placeholder="Address"></textarea>
    <button id="checkout-btn">Place Order</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<div id="booking-response" class="alert alert-success flash-message" style="display:none;">Booking confirmed!</div>
<!-- THEN put your script here -->
<script>
$(document).ready(function () {
 $('#loadBookingForm').click(function () {
          $.ajax({

                    url: '/ajax/booking/form/',  // URL for ajax_booking_form view
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {


                        $('#modalFormContainer').html(data.form_html); // inject form HTML
                        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'), {
                            backdrop: 'static',
                            keyboard: false
                        });
                        bookingModal.show();
                    },
                    error: function () {
                        alert('Failed to load booking form.');
                    }

                // end ajax
                });
            });
// end doc redy
});

</script>
<script>

// Function to get CSRF token from cookies
async function loadProducts() {
    try {

        //alert("in loadproducts")
        const response = await fetch('/api/products/');
        const products = await response.json();

        let container = document.getElementById('products-container');
        container.innerHTML = '<div class="product-grid">'; // Clear old products

        // Generate products list
        products.forEach(product => {
                                    container.innerHTML += `<ul><li>
                                        <div class="product">
                                        <img src="${product.image}" alt="${product.name}">
                                        <h3>${product.name}</h3>
                                        <p>₹${product.price}</p>
                                       <button class="buy-btn" type="button" onclick="addToCart1(${product.id},'${product.name}')" >Add to Cart</button>
                                       </div></li></ul>`
                                         });

         container.innerHTML += '</div>'
    } catch (error) {

        alert('laod error'+error);
        console.log('Error loading products:', error);
    }
}
document.addEventListener('DOMContentLoaded', loadProducts);
</script>
<script>
$(document).ready(function() {

    $(document).on('submit', '#bookingForm', function (e) {
        e.preventDefault();

        // Remove old AJAX error messages
        $(".ajax-error").remove();

        let formData = $(this).serialize();

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function (response) {
                if (response.status === "login_required") {
                    $('#bookingModal').modal('hide');
                    $('#loginModal').modal('show');
                }
                else if (response.status === "success") {
                    $('#bookingModal').modal('hide');
                    $('#booking-response')
                        .fadeIn()
                        .delay(3000)
                        .fadeOut();
                }
                else if (response.status === "error") {
                    // Loop through Django form errors and inject after the relevant <p>
                    for (let field in response.errors) {
                        let errorText = response.errors[field].join(", ");
                        let fieldElement = $(`#bookingForm [name="${field}"]`);
                        fieldElement.closest('p').append(
                            `<span class="ajax-error" style="color:red;display:block;font-size:0.9em;">${errorText}</span>`
                        );
                    }

                    // Handle non-field errors
                    if (response.errors.__all__) {
                        let nonFieldErrors = response.errors.__all__.join(", ");
                        $('#bookingForm').prepend(
                            `<div class="ajax-error" style="color:red;margin-bottom:10px;">${nonFieldErrors}</div>`
                        );
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
            }
        });
    });
});


async function addToCart1(product_id,product_name) {
        //  e.preventDefault();

       // alert(product_id)
          $.ajax({

                    type: 'POST',
                    url: '{% url 'cart_add' %}',
                    data:{product_id: product_id,csrfmiddlewaretoken: getCSRFToken(),action:'post'},
                    success: function(data) {
                     $("#cart-price").text("₹" +data.total_price);
                     $("#cart-count").text(data.total_quantity);

                    // showNotification("Add Cart","Selected Product added to cart ");
                     updateCartSummary(data);
                     showToast("✅ " + product_name + " added to cart!","success");


                    },

                    error: function (xhr, status, error) {
                      alert("Cart not added")                   }
                });
                // end ajax

}


// Load cart when modal opens
//document.getElementById('cartModalBtn').addEventListener('click', loadCartDetails);

$(document).ready(function() {

  $("#loginForm").submit(function(e) {
    e.preventDefault();

    $.ajax({
        url: "/ajax/login/",
        type: "POST",
        csrfmiddlewaretoken: getCSRFToken(),action:'post',
        data: $(this).serialize(),
        success: function(response) {
            if (response.status === "success") {
                $("#loginModal").modal("hide");
                showNotification("success", "✅ Login successful! Please try booking again.");
                window.location.reload();
            } else {
                showNotification("error", "❌ " + response.message);
            }
        }
    });
    });


        //end of doc redy

    });
   function showNotification(type, text) {
    const container = document.getElementById("notification-container");

    // Create notification div
    const notif = document.createElement("div");
    notif.className = `alert alert-success alert-dismissible fade show`;
    notif.innerHTML = text;

    container.appendChild(notif);
                       $('#notification-container')
                        .fadeIn()
                        .delay(2000)
                        .fadeOut();

    // Auto-remove after 3 seconds with fade animation
    setTimeout(() => {
        notif.style.animation = "fadeOut 0.9s forwards";
        setTimeout(() => notif.remove(), 500);
    }, 4000);
}


// Load cart data when modal is opened
document.getElementById("cartModal").addEventListener("show.bs.modal", async () => {
    //await refreshCartModal();
});
</script>
<script>
document.addEventListener('DOMContentLoaded', loadProducts);
function updateCartSummary(data) {
    // ✅ Update modal totals

    $("#cart-price").text("₹" +data.total_price);
 $("#cartprice").text("₹" +data.total_price);
    // ✅ Update navbar count
    $("#cart-qty").text(data.total_quantity);

     let badge = $("#cart-count");
    let cartBtn = $("#cart-btn");

    // ✅ Show/hide badge
    if (data.total_quantity > 0) {
        badge.text(data.total_quantity).show();

        // ߎ Badge bounce
        badge.addClass("badge-animate");
        setTimeout(() => badge.removeClass("badge-animate"), 500);

        // ߎ Cart button shake
        cartBtn.addClass("cart-shake");
        setTimeout(() => cartBtn.removeClass("cart-shake"), 600);
    } else {
        badge.hide();
    }

    // ✅ Rebuild modal table
    let tbody = $("#cart-table tbody");
     tbody.empty();
     //alert(data.items.length)
    if (data.items.length === 0) {
        tbody.append("<tr><td colspan='5'>ߛ Cart is empty</td></tr>");
        return;
    }

    data.items.forEach(item => {
        let row = `
            <tr data-id="${item.id}">
                <td>${item.name}</td>
                <td>₹${item.price}</td>
                <td>
                    <input type="number" class="update-qty form-control d-inline"
                           value="${item.quantity}" min="1" style="width:70px">
                </td>
                <td>₹${item.subtotal}</td>
                <td>
                    <button class="btn btn-sm btn-success update-cart">Update</button>
                    <button class="btn btn-sm btn-danger remove-from-cart">Remove</button>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
}
$('#cartModal').on('show.bs.modal', function () {

      //alert("cart loaded")
    $.get("/cart1/detail/", function (data) {
        updateCartSummary(data);
    });
});

$(document).ready(function () {
    $.get("/cart1/detail/", function (data) {
        updateCartSummary(data);
    });
});

$(document).on("click", ".remove-from-cart", function() {
    let productId = $(this).closest("tr").data("id");
//alert(productId);
    $.post("/cart1/remove/", { product_id: productId, csrfmiddlewaretoken: csrftoken ,action:'post'},
        function(data) {

            //showNotification("Shopping Cart","Product removed from  Cart Successfully ");
             updateCartSummary(data);
             showToast("❌ " + $(this).closest("tr").data("name") + " removed from cart!", "danger");
        }
    );
});
$(document).on("click", ".update-cart", function() {
    let row = $(this).closest("tr");
    let productId = row.data("id");
    let qty = row.find(".update-qty").val();

    $.post("/cart1/update/", { product_id: productId, quantity: qty, csrfmiddlewaretoken: csrftoken,action:'post' },
        function(data) {

        //showNotification("Shopping Cart","Shopping Cart Update Successfully ");
            updateCartSummary(data);  // ✅ refresh

             showToast("ߔ " +  row.data("name") + " updated!", "info");
        }
    );
});


function showToast(message, type="success") {
    let id = "toast-" + Date.now();

    let bgClass = "bg-success";
    if (type === "info") bgClass = "bg-info";
    if (type === "danger") bgClass = "bg-danger";

    let toastHtml = `
      <div id="${id}" class="toast align-items-center text-white ${bgClass} border-0 mb-2" role="alert">
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>
    `;

    $("#toast-container").append(toastHtml);

    let toastEl = document.getElementById(id);
    let toast = new bootstrap.Toast(toastEl, { delay: 3000 });

    // Slide in
    toastEl.addEventListener("shown.bs.toast", () => {
        toastEl.classList.add("show");

        // ߔ Play sound when toast appears
        let sound = document.getElementById("toast-sound");
if (sound) {
    try {
        sound.volume = 0.5;   // ߔ fixed at 50%
        sound.currentTime = 0;
        sound.play().catch(err => {
            console.warn("Toast sound could not play:", err.message);
        });
    } catch (e) {
        console.warn("Toast sound error:", e.message);
    }
}

    });

    // Slide out + remove
    toastEl.addEventListener("hide.bs.toast", () => {
        toastEl.classList.add("hide");
    });
    toastEl.addEventListener("hidden.bs.toast", () => {
        $(toastEl).remove();
    });

    toast.show();
}


    $("#checkout-btn").on("click", function(e) {
        e.preventDefault();

        $.ajax({
            url: "{% url 'checkout' %}",   // ✅ Django-safe URL
            type: "POST",
            headers: { "X-CSRFToken": csrftoken },
            data: {
                full_name: $("#full_name").val(),
                email: $("#email").val(),
                phone: $("#phone").val(),
                address: $("#address").val()
            },
            success: function(response) {
                if (response.success) {
                   showToast("Payment successful! Payment ID: " + response.order_id, "success");
                   window.location.href = "cart1/payment/" + response.order_id + "/";

                }
            },
            error: function(xhr) {
                alert("❌ Checkout failed: " + xhr.responseJSON?.error || "Unknown error");
            }
        });
    });


document.addEventListener("DOMContentLoaded", function () {

    document.getElementById("shop-now-btn").addEventListener("click", function () {

  });

  // Optional: close when clicking overlay
  const shopBtn = document.getElementById("shop-now-btn");
  const products = document.getElementById("products-container");
  const canvas = document.getElementById("sparkle-canvas");
  const backdrop = document.getElementById("backdrop");
  // ✅ Show products on button click
  if (shopBtn && products) {
    shopBtn.addEventListener("click", function () {
      backdrop.classList.add("active");

     products.classList.add("active");// document.getElementById("products").classList.add("active");

      products.style.display = "flex";
      products.scrollIntoView({ behavior: "smooth" });
        // Add "show" class for animation
    products.style.display = "block"; // make visible first
    setTimeout(() => {
        products.classList.add("show");
    }, 50);

    // Smooth scroll to products
    window.scrollTo({
   //     top: products.offsetTop - 50,
        behavior: "smooth"
    });

    });
  }
backdrop.addEventListener("click", function() {
  products.classList.remove("active");
  backdrop.classList.remove("active");
  });
  // ✅ Sparkle animation (only if canvas exists)
  if (canvas) {
    const ctx = canvas.getContext("2d");

    function resizeCanvas() {
      canvas.width = canvas.offsetWidth;
      canvas.height = canvas.offsetHeight;
    }
    resizeCanvas();
    window.addEventListener("resize", resizeCanvas);

    // sparkle particles
    const sparkles = [];
    function createSparkle() {
      sparkles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        size: Math.random() * 3 + 1,
        alpha: 1,
        decay: Math.random() * 0.02 + 0.01
      });
    }

    function drawSparkles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < sparkles.length; i++) {
        const s = sparkles[i];
        ctx.fillStyle = `rgba(255,255,255,${s.alpha})`;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
        s.alpha -= s.decay;
        if (s.alpha <= 0) {
          sparkles.splice(i, 1);
          i--;
        }
      }
    }

    function animate() {
      createSparkle();
      drawSparkles();
      requestAnimationFrame(animate);
    }
    animate();
  }
});

</script>
</body>

{% endblock %}
