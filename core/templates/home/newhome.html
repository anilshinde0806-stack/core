{% extends 'core/base.html' %}
{% block content %}
 {% load static %}
<style xmlns="http://www.w3.org/1999/html"></style>
    <meta charset="UTF-8">
    <title>Indian Flag</title>
    <!-- Load PyScript -->

<body style="text-align:center; background:#f0f0f0;">



      <div id="products-container" class="product-list"></div>`

<section class="hero"><h2 class="animated-text">Your Style, Our Passion</h2></section>
<!-- Success Message (initially hidden) -->
<div id="booking-response" class="alert alert-success text-center" style="display:none; position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 1055;">
    Booking successful!</div>
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-header">
             <h5 class="modal-title">Book Appointment</h5>
             <button type="button" class="btn-close flash-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
              <div class="modal-body" id="modalFormContainer">
                <!-- Form gets loaded here -->
              </div>
    </div>
  </div>
</div>

<span class="badge-new">
items - <span id="cartTotal">₹0</span>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#cartModal" id="cart">
    Cart <span id="cartCount" class="badge bg-danger">0</span>
</button>
</span>

<section class="services">
    <h3>Our Services</h3>
    <div class="service-grid">
        <div class="service">
            <i class="fa-solid fa-person"></i>
            <h4>Haircuts</h4>
            <p>Trendy styles for men & women</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-spa"></i>
            <h4>Spa & Relaxation</h4>
            <p>Facials, massages, and more</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-bahai"></i>
            <h4>Hair Coloring</h4>
            <p>Vibrant, bold or natural tones</p>
        </div>
        <div class="service">
            <i class="fa-solid fa-hand-sparkles"></i>
            <h4>Manicure & Pedicure</h4>
            <p>Clean, care & polish your nails</p>
        </div>
    </div>
</section>

<style>
</style>
{% if user.is_authenticated and not user.is_staff %}
  <!-- Booking form for normal logged-in users -->
  <section id="mini-booking">
    <h3>Quick Booking</h3>
    <form id="booking-form" method="post" action="">
      {% csrf_token %}
      <input type="text" name="service" placeholder="Service" required>
      <input type="date" name="date" required>
      <input type="time" name="time" required>
      <button type="submit">Book</button>
    </form>
    <div id="booking-response"></div>
  </section>
{% else %}
  {% if not user.is_authenticated %}
    <p><a href="{% url 'login' %}">Log in</a> to book an appointment.</p>
  {% endif %}
{% endif %}
<section id="booking-section">
<section class="cta">
    <h3>Ready for a new look?</h3>
    <p>Book an appointment with our expert stylists today.</p>
    <button id="loadBookingForm" class="cta-btn">Book Now</button>
</section>
</section>
<section class="testimonials">
    <h2>What Our Clients Say</h2>
    <div id="testimonialCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <p>"Amazing service! The best haircut I’ve had in years."</p>
                <strong>- Priya K.</strong>
            </div>
            <div class="carousel-item">
                <p>"Super clean and friendly staff. Highly recommended!"</p>
                <strong>- Rahul S.</strong>
            </div>
            <div class="carousel-item">
                <p>"I love the spa and the relaxation treatments. Highly recommend!"</p>
                <strong>- Neha T.</strong>
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#testimonialCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#testimonialCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
        </button>
    </div>
</section>
<section class="gallery">
    <h2>Salon Gallery</h2>
    <div class="gallery-grid">
        <div class="gallery-item">
            <img src="{% static 'images/gallery1.jpeg' %}" alt="Gallery 1" class="img-fluid">
            <div class="gallery-caption">Hair Styling</div>
        </div>
        <div class="gallery-item">
            <img src="{% static 'images/gallery2.jpeg' %}" alt="Gallery 2" class="img-fluid">
            <div class="gallery-caption">Relaxation Spa</div>
        </div>
        <div class="gallery-item">
            <img src="{% static 'images/gallery3.jpeg' %}" alt="Gallery 3" class="img-fluid">
            <div class="gallery-caption">Hair Coloring</div>
        </div>
    </div>
</section>
<!-- Cart Modal -->

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Your Cart</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <table class="table table-striped">
          <thead>
            <tr>
              <th>Item</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Subtotal</th>
            </tr>
          </thead>
          <tbody id="cartTableBody"></tbody>
        </table>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <a href="/checkout/" class="btn btn-success">Checkout</a>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<div id="booking-response" class="alert alert-success flash-message" style="display:none;">Booking confirmed!</div>
<!-- THEN put your script here -->
<script>
$(document).ready(function () {
 $('#loadBookingForm').click(function () {
          $.ajax({

                    url: '/ajax/booking/form/',  // URL for ajax_booking_form view
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {


                        $('#modalFormContainer').html(data.form_html); // inject form HTML
                        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'), {
                            backdrop: 'static',
                            keyboard: false
                        });
                        bookingModal.show();
                    },
                    error: function () {
                        alert('Failed to load booking form.');
                    }

                // end ajax
                });
            });
// end doc redy
});

</script>
<script>

// Function to get CSRF token from cookies
async function loadProducts() {
    try {

        //alert("in loadproducts")
        const response = await fetch('/api/products/');
        const products = await response.json();

        let container = document.getElementById('products-container');
        container.innerHTML = ''; // Clear old products

        // Generate products list
        products.forEach(product => {
                                    container.innerHTML += `<ul><li>
                                        <div class="product-card">
                                        <img src="${product.image}" alt="${product.name}">
                                        <h3>${product.name}</h3>
                                        <p>₹${product.price}</p>
                                       <button class="buy-btn" onclick="addToCart1(${product.id},'${product.name}',${product.price})">Add to Cart</button>
                                       </div></li></ul>`
                                         });
    } catch (error) {

        alert('laod error'+error);
        console.log('Error loading products:', error);
    }
}
document.addEventListener('DOMContentLoaded', loadProducts);
</script>
<script>
$(document).ready(function() {

    $(document).on('submit', '#bookingForm', function (e) {
        e.preventDefault();

        // Remove old AJAX error messages
        $(".ajax-error").remove();

        let formData = $(this).serialize();

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: formData,
            success: function (response) {
                if (response.status === "login_required") {
                    $('#bookingModal').modal('hide');
                    $('#loginModal').modal('show');
                }
                else if (response.status === "success") {
                    $('#bookingModal').modal('hide');
                    $('#booking-response')
                        .fadeIn()
                        .delay(3000)
                        .fadeOut();
                }
                else if (response.status === "error") {
                    // Loop through Django form errors and inject after the relevant <p>
                    for (let field in response.errors) {
                        let errorText = response.errors[field].join(", ");
                        let fieldElement = $(`#bookingForm [name="${field}"]`);
                        fieldElement.closest('p').append(
                            `<span class="ajax-error" style="color:red;display:block;font-size:0.9em;">${errorText}</span>`
                        );
                    }

                    // Handle non-field errors
                    if (response.errors.__all__) {
                        let nonFieldErrors = response.errors.__all__.join(", ");
                        $('#bookingForm').prepend(
                            `<div class="ajax-error" style="color:red;margin-bottom:10px;">${nonFieldErrors}</div>`
                        );
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error("AJAX Error:", status, error);
            }
        });
    });
});


async function addToCart1(product_id, productName, price) {

    const formData = new FormData();
    formData.append('product_id', product_id);
    formData.append('name', productName);
    formData.append('price', price);
    //alert(formData);
    const response = await fetch('/api/cart/add/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken') // Needed for Django POST
        }
    });

    const data = await response.json();

    if (data.total_items !== undefined) {

        //alert(data.total_items);
        document.getElementById('cartCount').innerText = data.total_items;
        document.getElementById('cartTotal').innerText = "₹" + data.total_price;


        }else{alert("Product Not add , Try again!");}

     // loadCartDetails();
}

// Remove item with fade-out effect
document.addEventListener("click", async (event) => {
    if (event.target.classList.contains("remove-item")) {
        const productId = event.target.dataset.id;

        alert(productId)
        const cartItem = document.getElementById(`cart-item-${productId}`);

        const res = await fetch(`/api/cart/remove/${productId}/`, {method: "POST"});

        if (res.ok) {
            // Fade out animation before removing from DOM
            cartItem.style.transition = "opacity 0.3s ease";
            cartItem.style.opacity = "0";
            setTimeout(async () => {
                cartItem.remove();
                //await refreshCartModal(); // Reload cart after animation
            }, 300);
        }
    }
});


// Load cart when modal opens
//document.getElementById('cartModalBtn').addEventListener('click', loadCartDetails);

$(document).ready(function() {

  $("#loginForm").submit(function(e) {
    e.preventDefault();

    $.ajax({
        url: "/ajax/login/",
        type: "POST",
        data: $(this).serialize(),
        success: function(response) {
            if (response.status === "success") {
                $("#loginModal").modal("hide");
                showNotification("success", "✅ Login successful! Please try booking again.");
                window.location.reload();
            } else {
                showNotification("error", "❌ " + response.message);
            }
        }
    });
    });


        //end of doc redy

    });
   function showNotification(type, text) {
    const container = document.getElementById("notification-container");

    // Create notification div
    const notif = document.createElement("div");
    notif.className = `notification notification-${type}`;
    notif.innerHTML = text;

    container.appendChild(notif);

    // Auto-remove after 3 seconds with fade animation
    setTimeout(() => {
        notif.style.animation = "fadeOut 0.9s forwards";
        setTimeout(() => notif.remove(), 500);
    }, 8000);
}


// Load cart data when modal is opened
document.getElementById("cartModal").addEventListener("show.bs.modal", async () => {
    //await refreshCartModal();
});
</script>
<script>
$(document).ready(function () {
 $('#cart').click(function () {

      //e.preventDefault();
          $.ajax({

                    url: 'api/cart/',  // URL for ajax_booking_form view
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                      let cartHtml = '';
                    if (data.items.length === 0) {
                        cartHtml.innerHTML = `<tr><td colspan="3"><p class="text-muted">Your cart is empty.</p></td></tr>`;
                        return;
                    }
                      alert(data.items.length);
                    data.items.forEach(item => {
                        cartHtml += `
            <tr>
                <td>${item.name}</td>
                <td>₹${item.price}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart('${item.id}')">-</button>
                    ${item.quantity}
                    <button class="btn btn-sm btn-success" onclick="addToCart('${item.id}', '${item.name}', ${item.price})">+</button>
                </td>
                <td>₹${item.subtotal}</td>
                   </tr>`;
                    });
            cartHtml += `<tr>
                        <td colspan="3"><strong>Total</strong></td>
                        <td><strong>₹${data.total_price}</strong></td>
                    </tr>`;
                    document.getElementById('cartTableBody').innerHTML = cartHtml;
                    document.getElementById("cartCount").textContent = data.count;


                    },
                    error: function () {
                        alert('Failed to load cart item form.');
                    }

                // end ajax
                });
            });
// end doc redy
});
async function loadCartDetails() {

    //$(document).ready(function () {
            alert("load function");
          $.ajax({

                    url: 'api/cart/',  // URL for ajax_booking_form view
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                    document.getElementById("cartCount").textContent = data.count;
                      let cartHtml = '';
                    if (data.items.length === 0) {
                        cartHtml.innerHTML = `<tr><td colspan="3"><p class="text-muted">Your cart is empty.</p></td></tr>`;
                        return;
                    }

                    data.items.forEach(item => {
                        cartHtml += `
            <tr>
                <td>${item.name}</td>
                <td>₹${item.price}</td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeFromCart('${item.id}')">-</button>
                    ${item.quantity}
                    <button class="btn btn-sm btn-success" onclick="addToCart('${item.id}', '${item.name}', ${item.price})">+</button>
                </td>
                <td>₹${item.subtotal}</td>
                   </tr>`;
                    });
            cartHtml += `<tr>
                        <td colspan="3"><strong>Total</strong></td>
                        <td><strong>₹${data.total_price}</strong></td>
                    </tr>`;
                    document.getElementById('cartTableBody').innerHTML = cartHtml;
                    },
                    error: function () {
                        alert('Failed to load cart item form.');
                    }

                // end ajax
               // });
            });
// end doc redy

}
document.addEventListener('DOMContentLoaded', loadProducts);
</script>


</body>

{% endblock %}
